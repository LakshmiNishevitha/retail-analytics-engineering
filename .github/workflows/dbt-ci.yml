name: dbt CI (compile-only)

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  dbt-compile:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dbt (Snowflake adapter)
        run: |
          python -m pip install --upgrade pip
          pip install "dbt-snowflake==1.8.2"

      - name: Create dbt profiles.yml (NO SECRETS, compile-only)
        run: |
          mkdir -p ~/.dbt
          cat > ~/.dbt/profiles.yml << 'YAML'
          retail_dbt:
            target: ci
            outputs:
              ci:
                type: snowflake
                account: "DUMMY_ACCOUNT"
                user: "DUMMY_USER"
                password: "DUMMY_PASSWORD"
                role: "DUMMY_ROLE"
                database: "RETAIL_DW"
                warehouse: "RETAIL_WH"
                schema: "CI_COMPILE_ONLY"
                threads: 2
          YAML

      - name: dbt deps
        run: |
          dbt deps --project-dir dbt/retail_dbt --profiles-dir ~/.dbt

      - name: dbt compile (SAFE)
        run: |
          dbt compile --project-dir dbt/retail_dbt --profiles-dir ~/.dbt

